---
import Layout from '../../layouts/Layout.astro';

export const prerender = false;

const token = Astro.url.searchParams.get('token');
---

<Layout title="Verify Email">
  <main class="verify-email-container">
    <div class="verify-email-card">
      <h1>Email Verification</h1>
      
      {token ? (
        <div id="verification-status" data-token={token}>
          <p class="loading">Verifying your email...</p>
        </div>
      ) : (
        <div class="error">
          <p>Invalid verification link. Please check your email for the correct link.</p>
        </div>
      )}
    </div>
  </main>

  <script>
    const statusDiv = document.getElementById('verification-status');
    if (statusDiv) {
      const token = statusDiv.getAttribute('data-token');
      if (token) {
        fetch('/api/auth/verify-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: token })
        })
          .then(res => res.json())
          .then(data => {
            const statusDiv = document.getElementById('verification-status');
            if (statusDiv && data.ok) {
              statusDiv.innerHTML = `
                <div class="success">
                  <p>✓ Email verified successfully!</p>
                  <p>You can now <a href="/app/login">log in</a> to your account.</p>
                </div>
              `;
            } else if (statusDiv) {
              statusDiv.innerHTML = `
                <div class="error">
                  <p>✗ ${data.message || 'Verification failed'}</p>
                  <p><a href="/api/auth/resend-verification">Request a new verification email</a></p>
                </div>
              `;
            }
          })
          .catch(err => {
            console.error('Verification error:', err);
            const statusDiv = document.getElementById('verification-status');
            if (statusDiv) {
              statusDiv.innerHTML = `
                <div class="error">
                  <p>✗ An error occurred during verification</p>
                  <p><a href="/api/auth/resend-verification">Request a new verification email</a></p>
                </div>
              `;
            }
          });
      }
    }
  </script>

  <style>
    .verify-email-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 80vh;
      padding: 20px;
    }

    .verify-email-card {
      background: var(--card-bg, white);
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      max-width: 500px;
      width: 100%;
      text-align: center;
    }

    .verify-email-card h1 {
      margin-bottom: 30px;
      color: var(--text-primary, #333);
    }

    .loading {
      color: var(--text-secondary, #666);
      font-style: italic;
    }

    .success {
      color: var(--success-color, #28a745);
    }

    .success p:first-child {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .error {
      color: var(--error-color, #dc3545);
    }

    .error p:first-child {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 10px;
    }

    a {
      color: var(--link-color, #0066cc);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }
  </style>
</Layout>
